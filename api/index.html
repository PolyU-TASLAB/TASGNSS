
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../appendix/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>API - TASGNSS Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tasgnss-api-documents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="TASGNSS Documentation" class="md-header__button md-logo" aria-label="TASGNSS Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TASGNSS Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="TASGNSS Documentation" class="md-nav__button md-logo" aria-label="TASGNSS Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TASGNSS Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tasgnss" class="md-nav__link">
    <span class="md-ellipsis">
      tasgnss
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.Backend" class="md-nav__link">
    <span class="md-ellipsis">
      Backend
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backend">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tasgnss.Backend.astype" class="md-nav__link">
    <span class="md-ellipsis">
      astype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tasgnss.Backend.block_diag" class="md-nav__link">
    <span class="md-ellipsis">
      block_diag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tasgnss.Backend.to" class="md-nav__link">
    <span class="md-ellipsis">
      to
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.covecef" class="md-nav__link">
    <span class="md-ellipsis">
      covecef
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.doppler_observe_func" class="md-nav__link">
    <span class="md-ellipsis">
      doppler_observe_func
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.ecef_to_enu_direct" class="md-nav__link">
    <span class="md-ellipsis">
      ecef_to_enu_direct
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.enu_to_azel" class="md-nav__link">
    <span class="md-ellipsis">
      enu_to_azel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_atmosphere_error" class="md-nav__link">
    <span class="md-ellipsis">
      get_atmosphere_error
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_obs_pnt" class="md-nav__link">
    <span class="md-ellipsis">
      get_obs_pnt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_sagnac_corr" class="md-nav__link">
    <span class="md-ellipsis">
      get_sagnac_corr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_sat_pos" class="md-nav__link">
    <span class="md-ellipsis">
      get_sat_pos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.prange" class="md-nav__link">
    <span class="md-ellipsis">
      prange
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.preprocess_obs" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess_obs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.pseudorange_observe_func" class="md-nav__link">
    <span class="md-ellipsis">
      pseudorange_observe_func
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.read_obs" class="md-nav__link">
    <span class="md-ellipsis">
      read_obs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.split_obs" class="md-nav__link">
    <span class="md-ellipsis">
      split_obs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.wls_pnt_pos" class="md-nav__link">
    <span class="md-ellipsis">
      wls_pnt_pos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.wls_pnt_pos_vel" class="md-nav__link">
    <span class="md-ellipsis">
      wls_pnt_pos_vel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.xyz2enu" class="md-nav__link">
    <span class="md-ellipsis">
      xyz2enu
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Appendix
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tasgnss" class="md-nav__link">
    <span class="md-ellipsis">
      tasgnss
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.Backend" class="md-nav__link">
    <span class="md-ellipsis">
      Backend
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backend">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tasgnss.Backend.astype" class="md-nav__link">
    <span class="md-ellipsis">
      astype
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tasgnss.Backend.block_diag" class="md-nav__link">
    <span class="md-ellipsis">
      block_diag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tasgnss.Backend.to" class="md-nav__link">
    <span class="md-ellipsis">
      to
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.covecef" class="md-nav__link">
    <span class="md-ellipsis">
      covecef
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.doppler_observe_func" class="md-nav__link">
    <span class="md-ellipsis">
      doppler_observe_func
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.ecef_to_enu_direct" class="md-nav__link">
    <span class="md-ellipsis">
      ecef_to_enu_direct
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.enu_to_azel" class="md-nav__link">
    <span class="md-ellipsis">
      enu_to_azel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_atmosphere_error" class="md-nav__link">
    <span class="md-ellipsis">
      get_atmosphere_error
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_obs_pnt" class="md-nav__link">
    <span class="md-ellipsis">
      get_obs_pnt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_sagnac_corr" class="md-nav__link">
    <span class="md-ellipsis">
      get_sagnac_corr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.get_sat_pos" class="md-nav__link">
    <span class="md-ellipsis">
      get_sat_pos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.prange" class="md-nav__link">
    <span class="md-ellipsis">
      prange
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.preprocess_obs" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess_obs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.pseudorange_observe_func" class="md-nav__link">
    <span class="md-ellipsis">
      pseudorange_observe_func
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.read_obs" class="md-nav__link">
    <span class="md-ellipsis">
      read_obs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.split_obs" class="md-nav__link">
    <span class="md-ellipsis">
      split_obs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.wls_pnt_pos" class="md-nav__link">
    <span class="md-ellipsis">
      wls_pnt_pos
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.wls_pnt_pos_vel" class="md-nav__link">
    <span class="md-ellipsis">
      wls_pnt_pos_vel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tasgnss.xyz2enu" class="md-nav__link">
    <span class="md-ellipsis">
      xyz2enu
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tasgnss-api-documents">TASGNSS API Documents</h1>


<div class="doc doc-object doc-module">



<a id="tasgnss"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="tasgnss.Backend" class="doc doc-heading">
            <code>Backend</code>


</h2>


    <div class="doc doc-contents ">









              <details class="quote">
                <summary>Source code in <code>tasgnss/core.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Backend</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="o">=</span> <span class="n">use_torch</span>
        <span class="k">if</span> <span class="n">use_torch</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="o">=</span> <span class="n">torch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please install pytorch to enable the torch-based WLS&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">zeros</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eye</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">diag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linalg_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linalg_lstsq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">B</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="n">rcond</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 不传 dim 参数，让 PyTorch 自动处理</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_counts</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="n">return_counts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">degrees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">radians</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vstack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hstack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">requires_grad_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="n">requires_grad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">grad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">no_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">class</span><span class="w"> </span><span class="nc">NoGrad</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">NoGrad</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">block_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arrays</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a block diagonal matrix from provided arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manual implementation for NumPy</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="c1"># Calculate total shape</span>
            <span class="n">total_rows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">)</span>
            <span class="n">total_cols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">total_rows</span><span class="p">,</span> <span class="n">total_cols</span><span class="p">))</span>
            <span class="n">row_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">col_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">result</span><span class="p">[</span><span class="n">row_offset</span><span class="p">:</span><span class="n">row_offset</span> <span class="o">+</span> <span class="n">rows</span><span class="p">,</span> <span class="n">col_offset</span><span class="p">:</span><span class="n">col_offset</span> <span class="o">+</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="n">row_offset</span> <span class="o">+=</span> <span class="n">rows</span>
                <span class="n">col_offset</span> <span class="o">+=</span> <span class="n">cols</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_or_array</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the data type of the input array/tensor.</span>
<span class="sd">        Automatically dispatches to torch.to(dtype) or np.astype(dtype)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tensor_or_array</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tensor_or_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_or_array</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move tensor to device (if using torch), or do nothing (if using numpy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tensor_or_array</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tensor_or_array</span>

    <span class="c1"># ========== 常用数据类型属性 ==========</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">float16</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">float32</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">float64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">int8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">int8</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">int16</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">int16</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">int32</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">int64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">uint8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">complex64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">complex64</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">complex128</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">complex128</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="tasgnss.Backend.astype" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">astype</span><span class="p">(</span><span class="n">tensor_or_array</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert the data type of the input array/tensor.
Automatically dispatches to torch.to(dtype) or np.astype(dtype)</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">astype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_or_array</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the data type of the input array/tensor.</span>
<span class="sd">    Automatically dispatches to torch.to(dtype) or np.astype(dtype)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_or_array</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_or_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tasgnss.Backend.block_diag" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a block diagonal matrix from provided arrays.</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">block_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arrays</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a block diagonal matrix from provided arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Manual implementation for NumPy</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="c1"># Calculate total shape</span>
        <span class="n">total_rows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">)</span>
        <span class="n">total_cols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">total_rows</span><span class="p">,</span> <span class="n">total_cols</span><span class="p">))</span>
        <span class="n">row_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">col_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
            <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">result</span><span class="p">[</span><span class="n">row_offset</span><span class="p">:</span><span class="n">row_offset</span> <span class="o">+</span> <span class="n">rows</span><span class="p">,</span> <span class="n">col_offset</span><span class="p">:</span><span class="n">col_offset</span> <span class="o">+</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
            <span class="n">row_offset</span> <span class="o">+=</span> <span class="n">rows</span>
            <span class="n">col_offset</span> <span class="o">+=</span> <span class="n">cols</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tasgnss.Backend.to" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to</span><span class="p">(</span><span class="n">tensor_or_array</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Move tensor to device (if using torch), or do nothing (if using numpy).</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_or_array</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move tensor to device (if using torch), or do nothing (if using numpy).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_torch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_or_array</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_or_array</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="tasgnss.covecef" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">covecef</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert covariance from ENU to ECEF
Parameters:
    pos: tuple or array of (lat, lon) in degrees
    Q: 3x3 covariance matrix in ENU frame
Returns:
    Q_ecef: 3x3 covariance matrix in ECEF frame</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">covecef</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert covariance from ENU to ECEF</span>
<span class="sd">    Parameters:</span>
<span class="sd">        pos: tuple or array of (lat, lon) in degrees</span>
<span class="sd">        Q: 3x3 covariance matrix in ENU frame</span>
<span class="sd">    Returns:</span>
<span class="sd">        Q_ecef: 3x3 covariance matrix in ECEF frame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">xyz2enu</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q</span> <span class="o">@</span> <span class="n">E</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.doppler_observe_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">doppler_observe_func</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">satpos</span><span class="p">,</span> <span class="n">satvel</span><span class="p">,</span> <span class="n">sdT</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Computes Doppler (range-rate) observation residuals and their Jacobian matrix for GNSS velocity estimation.
This function models the geometric relative velocity, Earth rotation (Sagnac) correction, and receiver-satellite clock drift difference.
The state vector assumed is: [vx, vy, vz, dT] — velocity + public clock drift (no position or clock bias).
Clock bias is handled externally (e.g., in pseudorange module), enabling modular design via block_diag fusion.</p>
<p>Parameters:
vel : receiver velocity vector, shape (3,)
dT : public pseudorange rate for all systems, shape (1,), unit: m/s
pos : approximate receiver position (ECEF), shape (3,) — precision ~100m sufficient
satpos : satellite positions (ECEF), shape (n_obs, 3)
satvel : satellite velocities (ECEF), shape (n_obs, 3)
sdT : satellite clock drifts (from broadcast/SP3), shape (n_obs,), unit: s/s
sys : list of GNSS system identifiers for each observation, e.g., ['G', 'E', 'C']
enable_torch : if True, use PyTorch backend for computations
device : if enable_torch is True, specifies the device ('cpu' or 'cuda')</p>
<p>Returns:
v : predicted Doppler velocity residuals (m/s), shape (n_obs, 1)
H : Jacobian matrix w.r.t state [vx, vy, vz, dT], shape (n_obs, 4)</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">doppler_observe_func</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">satpos</span><span class="p">,</span> <span class="n">satvel</span><span class="p">,</span> <span class="n">sdT</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Doppler (range-rate) observation residuals and their Jacobian matrix for GNSS velocity estimation.</span>
<span class="sd">    This function models the geometric relative velocity, Earth rotation (Sagnac) correction, and receiver-satellite clock drift difference.</span>
<span class="sd">    The state vector assumed is: [vx, vy, vz, dT] — velocity + public clock drift (no position or clock bias).</span>
<span class="sd">    Clock bias is handled externally (e.g., in pseudorange module), enabling modular design via block_diag fusion.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    vel : receiver velocity vector, shape (3,)</span>
<span class="sd">    dT : public pseudorange rate for all systems, shape (1,), unit: m/s</span>
<span class="sd">    pos : approximate receiver position (ECEF), shape (3,) — precision ~100m sufficient</span>
<span class="sd">    satpos : satellite positions (ECEF), shape (n_obs, 3)</span>
<span class="sd">    satvel : satellite velocities (ECEF), shape (n_obs, 3)</span>
<span class="sd">    sdT : satellite clock drifts (from broadcast/SP3), shape (n_obs,), unit: s/s</span>
<span class="sd">    sys : list of GNSS system identifiers for each observation, e.g., [&#39;G&#39;, &#39;E&#39;, &#39;C&#39;]</span>
<span class="sd">    enable_torch : if True, use PyTorch backend for computations</span>
<span class="sd">    device : if enable_torch is True, specifies the device (&#39;cpu&#39; or &#39;cuda&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">    v : predicted Doppler velocity residuals (m/s), shape (n_obs, 1)</span>
<span class="sd">    H : Jacobian matrix w.r.t state [vx, vy, vz, dT], shape (n_obs, 4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">Backend</span><span class="p">(</span><span class="n">enable_torch</span><span class="p">)</span>

    <span class="c1"># 转换所有输入为 float64 并移动到 device</span>
    <span class="n">dT</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">satpos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">satvel</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">satvel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">sdT</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sdT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">vel</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">dT</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dT</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">satpos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">satvel</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">satvel</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">sdT</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">sdT</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># 计算单位向量 e</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">satpos</span> <span class="o">-</span> <span class="n">pos</span>  <span class="c1"># shape: (n_obs, 3)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_norm</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs, 1)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span> <span class="o">/</span> <span class="n">norm</span>  <span class="c1"># shape: (n_obs, 3)</span>

    <span class="c1"># 几何相对速度项</span>
    <span class="n">rel_vel</span> <span class="o">=</span> <span class="n">satvel</span> <span class="o">-</span> <span class="n">vel</span>  <span class="c1"># shape: (n_obs, 3)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="o">-</span><span class="n">backend</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">rel_vel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs,)</span>

    <span class="c1"># Sagnac 修正项</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">OMGE</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">CLIGHT</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">satvel</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">satvel</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
        <span class="n">satpos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">satpos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># shape: (n_obs,)</span>

    <span class="c1"># 钟差项</span>
    <span class="n">v_clock</span> <span class="o">=</span> <span class="n">dT</span> <span class="o">-</span> <span class="n">prl</span><span class="o">.</span><span class="n">CLIGHT</span> <span class="o">*</span> <span class="n">sdT</span>  <span class="c1"># shape: (n_obs,)</span>

    <span class="c1"># 总 Doppler 预测值</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">v_clock</span>  <span class="c1"># shape: (n_obs,)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs, 1)</span>


    <span class="c1"># 构造 Jacobian H: [∂v/∂vx, ∂v/∂vy, ∂v/∂vz, ∂v/∂dT]</span>
    <span class="n">H_t</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs, 1)</span>
    <span class="n">H_t</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">H_t</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="n">H_t</span><span class="p">))</span>  <span class="c1"># shape: (n_obs, 4)</span>

    <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="n">H</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.ecef_to_enu_direct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ecef_to_enu_direct</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">recv_pos</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert satellite ECEF coordinates to receiver ENU coordinate system.
Parameters:
    satpos : ndarray
        Satellite ECEF coordinates (n, 3)
    recv_pos : ndarray
        Receiver ECEF coordinates (1, 3)
Returns:
    enu : ndarray
        Satellite ENU coordinates (n, 3)</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ecef_to_enu_direct</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">recv_pos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert satellite ECEF coordinates to receiver ENU coordinate system.</span>
<span class="sd">    Parameters:</span>
<span class="sd">        satpos : ndarray</span>
<span class="sd">            Satellite ECEF coordinates (n, 3)</span>
<span class="sd">        recv_pos : ndarray</span>
<span class="sd">            Receiver ECEF coordinates (1, 3)</span>
<span class="sd">    Returns:</span>
<span class="sd">        enu : ndarray</span>
<span class="sd">            Satellite ENU coordinates (n, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Calculate the latitude and longitude of the receiver</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">p3d</span><span class="o">.</span><span class="n">ecef2geodetic</span><span class="p">(</span><span class="n">recv_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recv_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">recv_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1"># Step 2: Calculate the relative vector from satellite to receiver (u, v, w)</span>
    <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">satpos</span> <span class="o">-</span> <span class="n">recv_pos</span>  <span class="c1"># (n, 3)</span>
    <span class="c1"># Step 3: Construct the rotation matrix from ECEF to ENU</span>
    <span class="n">sin_lat</span><span class="p">,</span> <span class="n">cos_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
    <span class="n">sin_lon</span><span class="p">,</span> <span class="n">cos_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="o">-</span><span class="n">sin_lon</span><span class="p">,</span> <span class="n">cos_lon</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">sin_lat</span> <span class="o">*</span> <span class="n">cos_lon</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_lat</span> <span class="o">*</span> <span class="n">sin_lon</span><span class="p">,</span> <span class="n">cos_lat</span><span class="p">],</span>
        <span class="p">[</span><span class="n">cos_lat</span> <span class="o">*</span> <span class="n">cos_lon</span><span class="p">,</span> <span class="n">cos_lat</span> <span class="o">*</span> <span class="n">sin_lon</span><span class="p">,</span> <span class="n">sin_lat</span><span class="p">]</span>
    <span class="p">])</span>
    <span class="c1"># Step 4: Batch convert to ENU coordinates</span>
    <span class="n">enu</span> <span class="o">=</span> <span class="n">rel_pos</span> <span class="o">@</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Matrix multiplication</span>
    <span class="k">return</span> <span class="n">enu</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.enu_to_azel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">enu_to_azel</span><span class="p">(</span><span class="n">enu</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert ENU coordinates to azimuth and elevation angles.
Parameters:
    enu : ndarray
        ENU coordinates (n, 3), each row represents [E, N, U]
Returns:
    azimuth : ndarray
        Azimuth angle array (n,)
    elevation : ndarray
        Elevation angle array (n,)</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">enu_to_azel</span><span class="p">(</span><span class="n">enu</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ENU coordinates to azimuth and elevation angles.</span>
<span class="sd">    Parameters:</span>
<span class="sd">        enu : ndarray</span>
<span class="sd">            ENU coordinates (n, 3), each row represents [E, N, U]</span>
<span class="sd">    Returns:</span>
<span class="sd">        azimuth : ndarray</span>
<span class="sd">            Azimuth angle array (n,)</span>
<span class="sd">        elevation : ndarray</span>
<span class="sd">            Elevation angle array (n,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">enu</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">enu</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">enu</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Calculate azimuth</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># Return value range [-pi, pi]</span>
    <span class="c1">#azimuth = np.degrees(azimuth)  # Convert to degrees</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># Ensure range in [0, 360]</span>

    <span class="c1"># Calculate elevation</span>
    <span class="n">horizontal_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Horizontal distance</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">horizontal_distance</span><span class="p">)</span>  <span class="c1"># Return value range [-pi/2, pi/2]</span>
    <span class="c1">#elevation = np.degrees(elevation)  # Convert to degrees</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">degree</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">elevation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">azimuth</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">elevation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.get_atmosphere_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_atmosphere_error</span><span class="p">(</span><span class="n">gtime</span><span class="p">,</span> <span class="n">satpos</span><span class="p">,</span> <span class="n">satprns</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Computes modeled atmospheric delay errors (ionospheric, tropospheric) and associated observation variances for a set of satellites at a given epoch.
Designed for use in GNSS positioning and quality control — especially in multipath-prone environments like urban canyons.</p>


<details class="note" open>
  <summary>This function uses RTKLIB’s built-in models:</summary>
  <p>Ionosphere: IONOOPT_BRDC (broadcast Klobuchar model)
Troposphere: TROPOPT_SAAS (Saastamoinen model)</p>
</details>        <p>gtime (gtime_t):
    Epoch time in RTKLIB’s internal time format.</p>
<p>satpos (List[ArrayLike] or ndarray of shape (n, 6)):
    Satellite positions and velocities for each satellite, packed as [x, y, z, vx, vy, vz] (ECEF, meters and m/s).</p>
<p>satprns (List[int]):
    List of satellite PRN numbers (e.g., [1, 5, 12, 19]).</p>
<p>nav (nav_t):
    Navigation data structure containing ionospheric/tropospheric model parameters (e.g., broadcast iono coeffs).</p>
<p>p (ArrayLike, length=3):
    Receiver approximate position in ECEF coordinates [X, Y, Z] (meters). Used to compute elevation/azimuth and atmospheric delays.</p>
        <p>iono_error (ndarray, shape=(n,)):
    The modeled ionospheric delay per satellite: dion (meters).</p>
<p>trop_error (ndarray, shape=(n,)):
    The modeled tropospheric delay per satellite: dtrp (meters).</p>
<p>var_el (ndarray, shape=(n,)):
    Elevation-dependent variance (empirical model, e.g., for multipath suppression in urban canyons). Computed via RTKLIBvar(azel[1], sys).</p>
<p>var_iono (ndarray, shape=(n,)):
    Broadcast ionospheric model variance (squared standard deviation, m²), output from ionocorr.</p>
<p>var_tropo (ndarray, shape=(n,)):
    Saastamoinen tropospheric model variance (m²), output from tropcorr.</p>


<details class="processing-steps" open>
  <summary>Processing Steps</summary>
  <p>Converts receiver ECEF position p to geodetic coordinates (pos) using ecef2pos.
For each satellite:
    Computes line-of-sight vector and satellite elevation/azimuth using geodist and satazel.
    Calculates ionospheric delay (dion) and its variance (vion) via ionocorr(..., IONOOPT_BRDC, ...).
    Calculates tropospheric delay (dtrp) and its variance (vtrp) via tropcorr(..., TROPOPT_SAAS, ...).
    Computes elevation-based variance (vel) using RTKLIBvar(elevation, system) — useful for downweighting low-elevation satellites.
Returns arrays of total atmospheric error and component variances.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_atmosphere_error</span><span class="p">(</span><span class="n">gtime</span><span class="p">,</span> <span class="n">satpos</span><span class="p">,</span> <span class="n">satprns</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes modeled atmospheric delay errors (ionospheric, tropospheric) and associated observation variances for a set of satellites at a given epoch.</span>
<span class="sd">    Designed for use in GNSS positioning and quality control — especially in multipath-prone environments like urban canyons.</span>

<span class="sd">    Note: This function uses RTKLIB’s built-in models:</span>
<span class="sd">        Ionosphere: IONOOPT_BRDC (broadcast Klobuchar model)</span>
<span class="sd">        Troposphere: TROPOPT_SAAS (Saastamoinen model)</span>

<span class="sd">    Parameters:</span>
<span class="sd">    gtime (gtime_t):</span>
<span class="sd">        Epoch time in RTKLIB’s internal time format.</span>

<span class="sd">    satpos (List[ArrayLike] or ndarray of shape (n, 6)):</span>
<span class="sd">        Satellite positions and velocities for each satellite, packed as [x, y, z, vx, vy, vz] (ECEF, meters and m/s).</span>

<span class="sd">    satprns (List[int]):</span>
<span class="sd">        List of satellite PRN numbers (e.g., [1, 5, 12, 19]).</span>

<span class="sd">    nav (nav_t):</span>
<span class="sd">        Navigation data structure containing ionospheric/tropospheric model parameters (e.g., broadcast iono coeffs).</span>

<span class="sd">    p (ArrayLike, length=3):</span>
<span class="sd">        Receiver approximate position in ECEF coordinates [X, Y, Z] (meters). Used to compute elevation/azimuth and atmospheric delays.</span>

<span class="sd">    Returns:</span>
<span class="sd">    iono_error (ndarray, shape=(n,)):</span>
<span class="sd">        The modeled ionospheric delay per satellite: dion (meters).</span>

<span class="sd">    trop_error (ndarray, shape=(n,)):</span>
<span class="sd">        The modeled tropospheric delay per satellite: dtrp (meters).</span>

<span class="sd">    var_el (ndarray, shape=(n,)):</span>
<span class="sd">        Elevation-dependent variance (empirical model, e.g., for multipath suppression in urban canyons). Computed via RTKLIBvar(azel[1], sys).</span>

<span class="sd">    var_iono (ndarray, shape=(n,)):</span>
<span class="sd">        Broadcast ionospheric model variance (squared standard deviation, m²), output from ionocorr.</span>

<span class="sd">    var_tropo (ndarray, shape=(n,)):</span>
<span class="sd">        Saastamoinen tropospheric model variance (m²), output from tropcorr.</span>

<span class="sd">    Processing Steps:</span>
<span class="sd">        Converts receiver ECEF position p to geodetic coordinates (pos) using ecef2pos.</span>
<span class="sd">        For each satellite:</span>
<span class="sd">            Computes line-of-sight vector and satellite elevation/azimuth using geodist and satazel.</span>
<span class="sd">            Calculates ionospheric delay (dion) and its variance (vion) via ionocorr(..., IONOOPT_BRDC, ...).</span>
<span class="sd">            Calculates tropospheric delay (dtrp) and its variance (vtrp) via tropcorr(..., TROPOPT_SAAS, ...).</span>
<span class="sd">            Computes elevation-based variance (vel) using RTKLIBvar(elevation, system) — useful for downweighting low-elevation satellites.</span>
<span class="sd">        Returns arrays of total atmospheric error and component variances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">satprns</span><span class="p">)</span>
    <span class="n">satsys</span> <span class="o">=</span> <span class="n">get_list_sat_name</span><span class="p">(</span><span class="n">satprns</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">azel</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">prl</span><span class="o">.</span><span class="n">ecef2pos</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">dion</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vion</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dtrp</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vtrp</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">vels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vtrps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ion_err</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">trop_err</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sysname</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Dchar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">make1Darray</span><span class="p">(</span><span class="n">satpos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">)</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">geodist</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">rr</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">satazel</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">azel</span><span class="p">)</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">ionocorr</span><span class="p">(</span><span class="n">gtime</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">satprns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pos</span><span class="p">,</span><span class="n">azel</span><span class="p">,</span><span class="n">prl</span><span class="o">.</span><span class="n">IONOOPT_BRDC</span><span class="p">,</span><span class="n">dion</span><span class="p">,</span><span class="n">vion</span><span class="p">)</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">tropcorr</span><span class="p">(</span><span class="n">gtime</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">azel</span><span class="p">,</span><span class="n">prl</span><span class="o">.</span><span class="n">TROPOPT_SAAS</span><span class="p">,</span><span class="n">dtrp</span><span class="p">,</span><span class="n">vtrp</span><span class="p">)</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">RTKLIBvar</span><span class="p">(</span><span class="n">azel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">satsys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">vels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">vions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vion</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">vtrps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtrp</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">ion_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dion</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">trop_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtrp</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ion_err</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trop_err</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vions</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vtrps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.get_obs_pnt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_obs_pnt</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">prcopt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Performs Single Point Positioning (SPP) by directly calling RTKLIB’s pntpos() function.
Returns the computed position/velocity solution, success/failure status, and diagnostic message.</p>
<p>Ideal for quick, standalone positioning without filters or ambiguity resolution.</p>
        <p>obs (obs_t):
    GNSS observation data structure for one epoch (must contain data[0..n-1] of type obsd_t).</p>
<p>nav (nav_t):
    Navigation data structure with ephemerides, ionospheric/tropospheric models, and satellite biases.</p>
<p>prcopt (prcopt_t, optional):
    Processing options (e.g., iono/tropo model, elevation mask, positioning mode).
    If None, defaults to prl.prcopt_default.</p>
        <p>sol (sol_t):
    Solution structure containing:
        sol.rr[0:3]: ECEF position [x, y, z] (meters)
        sol.rr[3:6]: ECEF velocity [vx, vy, vz] (m/s) — if computed
        sol.time: Epoch time
        Other metadata (refer to RTKLIB documentation for full details).</p>
<p>status (bool):
    True → Positioning succeeded (solution is valid)
    False → Positioning failed (check msg for reason)</p>
<p>msg (str):
    Diagnostic message from RTKLIB. Common failure reasons:
        "insufficient satellites"
        "gdop error" (GDOP too high)
        "chi-square error" (residual validation failed)
        "no navigation data"</p>


<details class="processing-flow" open>
  <summary>Processing Flow</summary>
  <p>Initializes solution and satellite status buffers.
Sets solution time to match first observation.
Calls RTKLIB’s pntpos() — computes SPP using pseudoranges, applies models (iono/tropo/dcbs), solves least-squares.
Returns raw result — no post-filtering or smoothing.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_obs_pnt</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">prcopt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs Single Point Positioning (SPP) by directly calling RTKLIB’s pntpos() function.</span>
<span class="sd">    Returns the computed position/velocity solution, success/failure status, and diagnostic message.</span>

<span class="sd">    Ideal for quick, standalone positioning without filters or ambiguity resolution.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    obs (obs_t):</span>
<span class="sd">        GNSS observation data structure for one epoch (must contain data[0..n-1] of type obsd_t).</span>

<span class="sd">    nav (nav_t):</span>
<span class="sd">        Navigation data structure with ephemerides, ionospheric/tropospheric models, and satellite biases.</span>

<span class="sd">    prcopt (prcopt_t, optional):</span>
<span class="sd">        Processing options (e.g., iono/tropo model, elevation mask, positioning mode).</span>
<span class="sd">        If None, defaults to prl.prcopt_default.</span>

<span class="sd">    Returns:</span>
<span class="sd">    sol (sol_t):</span>
<span class="sd">        Solution structure containing:</span>
<span class="sd">            sol.rr[0:3]: ECEF position [x, y, z] (meters)</span>
<span class="sd">            sol.rr[3:6]: ECEF velocity [vx, vy, vz] (m/s) — if computed</span>
<span class="sd">            sol.time: Epoch time</span>
<span class="sd">            Other metadata (refer to RTKLIB documentation for full details).</span>

<span class="sd">    status (bool):</span>
<span class="sd">        True → Positioning succeeded (solution is valid)</span>
<span class="sd">        False → Positioning failed (check msg for reason)</span>

<span class="sd">    msg (str):</span>
<span class="sd">        Diagnostic message from RTKLIB. Common failure reasons:</span>
<span class="sd">            &quot;insufficient satellites&quot;</span>
<span class="sd">            &quot;gdop error&quot; (GDOP too high)</span>
<span class="sd">            &quot;chi-square error&quot; (residual validation failed)</span>
<span class="sd">            &quot;no navigation data&quot;</span>

<span class="sd">    Processing Flow:</span>
<span class="sd">        Initializes solution and satellite status buffers.</span>
<span class="sd">        Sets solution time to match first observation.</span>
<span class="sd">        Calls RTKLIB’s pntpos() — computes SPP using pseudoranges, applies models (iono/tropo/dcbs), solves least-squares.</span>
<span class="sd">        Returns raw result — no post-filtering or smoothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prcopt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prcopt</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">prcopt_default</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">n</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">sol_t</span><span class="p">()</span>
    <span class="n">sat</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Dssat_t</span><span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">MAXSAT</span><span class="p">)</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Dchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">azel</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">prl</span><span class="o">.</span><span class="n">pntpos</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ptr</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">prcopt</span><span class="p">,</span><span class="n">sol</span><span class="p">,</span><span class="n">azel</span><span class="p">,</span><span class="n">sat</span><span class="o">.</span><span class="n">ptr</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">ptr</span> <span class="ow">and</span> <span class="s2">&quot;chi-square error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">ptr</span> <span class="ow">and</span> <span class="s2">&quot;gdop error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">ptr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sol</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">ptr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sol</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">ptr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.get_sagnac_corr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_sagnac_corr</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Computes the Sagnac correction (relativistic range correction due to Earth’s rotation) for GNSS positioning.
This effect arises because the Earth rotates during signal propagation, causing a relative motion between satellite and receiver in the ECEF frame.
The magnitude is typically ~3 meters and must be corrected for precise positioning.</p>
<p>Note: The receiver position p does not need to be highly accurate — even an error of ~100 meters introduces negligible change in the Sagnac correction.</p>
        <p>satpos (ndarray, shape=(n, 3) or (n, 6)):
    Satellite positions in ECEF coordinates [X, Y, Z] (meters). If 6-element vectors are passed (including velocity), only the first three are used.</p>
<p>p (ArrayLike, length=3):
    Approximate receiver position in ECEF coordinates [X, Y, Z] (meters). Accuracy requirement: ~100 m is sufficient.</p>
        <p>sagnac_corr (ndarray, shape=(n,)):
    Sagnac correction in meters, one value per satellite.</p>


<details class="why-it-matters" open>
  <summary>Why It Matters</summary>
  <p>The Sagnac effect is a relativistic correction that accounts for the fact that the ECEF frame is rotating.
As the signal travels from satellite to receiver (~0.07s), the Earth rotates slightly, causing a geometric discrepancy if positions are treated as static in ECEF.
This correction ensures consistency with the inertial frame assumption in GNSS signal models.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_sagnac_corr</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the Sagnac correction (relativistic range correction due to Earth’s rotation) for GNSS positioning.</span>
<span class="sd">    This effect arises because the Earth rotates during signal propagation, causing a relative motion between satellite and receiver in the ECEF frame.</span>
<span class="sd">    The magnitude is typically ~3 meters and must be corrected for precise positioning.</span>

<span class="sd">    Note: The receiver position p does not need to be highly accurate — even an error of ~100 meters introduces negligible change in the Sagnac correction.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    satpos (ndarray, shape=(n, 3) or (n, 6)):</span>
<span class="sd">        Satellite positions in ECEF coordinates [X, Y, Z] (meters). If 6-element vectors are passed (including velocity), only the first three are used.</span>

<span class="sd">    p (ArrayLike, length=3):</span>
<span class="sd">        Approximate receiver position in ECEF coordinates [X, Y, Z] (meters). Accuracy requirement: ~100 m is sufficient.</span>

<span class="sd">    Returns:</span>
<span class="sd">    sagnac_corr (ndarray, shape=(n,)):</span>
<span class="sd">        Sagnac correction in meters, one value per satellite.</span>

<span class="sd">    Why It Matters:</span>
<span class="sd">        The Sagnac effect is a relativistic correction that accounts for the fact that the ECEF frame is rotating.</span>
<span class="sd">        As the signal travels from satellite to receiver (~0.07s), the Earth rotates slightly, causing a geometric discrepancy if positions are treated as static in ECEF.</span>
<span class="sd">        This correction ensures consistency with the inertial frame assumption in GNSS signal models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sagnac_corr</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">OMGE</span><span class="o">*</span><span class="p">(</span><span class="n">satpos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">satpos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">prl</span><span class="o">.</span><span class="n">CLIGHT</span>
    <span class="k">return</span> <span class="n">sagnac_corr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.get_sat_pos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_sat_pos</span><span class="p">(</span><span class="n">obsd</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nav</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Computes satellite positions, velocities, clock biases, and associated ephemeris variances for a given epoch of observations.
Filters out satellites with invalid or missing ephemeris data and returns only valid entries.</p>
<p>Note: The input is obsd_t (i.e., obs.data), not obs_t.
Typical usage: get_sat_pos(obs.data, obs.n, nav)</p>
        <p>obsd (Arr1Dobsd_t or equivalent):
    Array of observation data for one epoch (e.g., obs.data). Must be contiguous and correspond to n satellites.</p>
<p>n (int):
    Number of satellites (i.e., number of elements in obsd) for this epoch.</p>
<p>nav (nav_t):
    Ephemeris and clock data structure, typically populated by read_obs() or equivalent.</p>
        <p>rr (Arr1Ddouble, length = 6 * len(mask)):
    Satellite positions and velocities, packed as [x, y, z, vx, vy, vz] for each valid satellite. Units: meters and meters/second.</p>
<p>dts (Arr1Ddouble, length = 2 * len(mask)):
    Satellite clock bias and drift, packed as [bias, drift] for each valid satellite. Units: seconds and seconds/second.</p>
<p>var (Arr1Ddouble, length = len(mask)):
    Ephemeris variance (squared standard deviation) for each valid satellite. Unit: m².</p>
<p>mask (List[int]):
    List of indices (from original 0..n-1) corresponding to satellites with valid ephemeris data. Used to map back to original observation order.</p>
<p>Processing Details:
Internally calls RTKLIB’s satposs() to compute satellite states.
Identifies satellites with invalid position data (where |x| &lt; 1e-10) as “no ephemeris”.
Constructs a mask of valid satellite indices.
Uses helper function arr_select to filter rs, dts, and var arrays according to the mask.
Returns filtered arrays and mask.</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_sat_pos</span><span class="p">(</span><span class="n">obsd</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nav</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes satellite positions, velocities, clock biases, and associated ephemeris variances for a given epoch of observations.</span>
<span class="sd">    Filters out satellites with invalid or missing ephemeris data and returns only valid entries.</span>

<span class="sd">    Note: The input is obsd_t (i.e., obs.data), not obs_t.</span>
<span class="sd">    Typical usage: get_sat_pos(obs.data, obs.n, nav)</span>

<span class="sd">    Parameters:</span>
<span class="sd">    obsd (Arr1Dobsd_t or equivalent):</span>
<span class="sd">        Array of observation data for one epoch (e.g., obs.data). Must be contiguous and correspond to n satellites.</span>

<span class="sd">    n (int):</span>
<span class="sd">        Number of satellites (i.e., number of elements in obsd) for this epoch.</span>

<span class="sd">    nav (nav_t):</span>
<span class="sd">        Ephemeris and clock data structure, typically populated by read_obs() or equivalent.</span>

<span class="sd">    Returns:</span>
<span class="sd">    rr (Arr1Ddouble, length = 6 * len(mask)):</span>
<span class="sd">        Satellite positions and velocities, packed as [x, y, z, vx, vy, vz] for each valid satellite. Units: meters and meters/second.</span>

<span class="sd">    dts (Arr1Ddouble, length = 2 * len(mask)):</span>
<span class="sd">        Satellite clock bias and drift, packed as [bias, drift] for each valid satellite. Units: seconds and seconds/second.</span>

<span class="sd">    var (Arr1Ddouble, length = len(mask)):</span>
<span class="sd">        Ephemeris variance (squared standard deviation) for each valid satellite. Unit: m².</span>

<span class="sd">    mask (List[int]):</span>
<span class="sd">        List of indices (from original 0..n-1) corresponding to satellites with valid ephemeris data. Used to map back to original observation order.</span>

<span class="sd">    Processing Details:</span>
<span class="sd">    Internally calls RTKLIB’s satposs() to compute satellite states.</span>
<span class="sd">    Identifies satellites with invalid position data (where |x| &lt; 1e-10) as “no ephemeris”.</span>
<span class="sd">    Constructs a mask of valid satellite indices.</span>
<span class="sd">    Uses helper function arr_select to filter rs, dts, and var arrays according to the mask.</span>
<span class="sd">    Returns filtered arrays and mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">svh</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Dint</span><span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">MAXOBS</span><span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">dts</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">prl</span><span class="o">.</span><span class="n">satposs</span><span class="p">(</span><span class="n">obsd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">obsd</span><span class="o">.</span><span class="n">ptr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">rs</span><span class="p">,</span><span class="n">dts</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">svh</span><span class="p">)</span>
    <span class="n">noeph</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">noeph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">noeph</span><span class="p">))</span>
    <span class="n">nrs</span> <span class="o">=</span> <span class="n">arr_select</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">arr_select</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">ndts</span> <span class="o">=</span> <span class="n">arr_select</span><span class="p">(</span><span class="n">dts</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">nrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nrs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ndts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndts</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nrs</span><span class="p">,</span><span class="n">ndts</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.prange" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prange</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Computes the corrected pseudorange for a single satellite observation, applying differential code bias (DCB) and ionospheric delay corrections based on configuration.
Supports both single-frequency and ionosphere-free dual-frequency combinations.</p>
        <p>obs (obsd_t):
    Single satellite observation record from an epoch (e.g., obs.data[i]). Must contain pseudorange measurements (P[0], P[1]) and signal codes (code[0], code[1]).</p>
<p>nav (nav_t):
    Ephemeris and satellite bias structure containing DCB (differential code bias) and TGD (time group delay) corrections.</p>
<p>opt (prcopt_t or equivalent):
    Processing options structure. Key field:
    opt.ionoopt: Specifies ionospheric correction mode (e.g., IONOOPT_IFLC for ionosphere-free linear combination).</p>
<p>var (Arr1Ddouble, length ≥ 1):
    Output array — var[0] is set to the default code variance (0.3² m²) for single-frequency cases. Not modified in dual-frequency mode.</p>
        <p>p (float):
    Corrected pseudorange in meters. Returns 0.0 if:
    P1 is missing, or
    Dual-frequency mode is enabled but P2 is missing.</p>
<p>Processing Logic:
DCB Correction (C1→P1, C2→P2):
    Applied for GPS and GLONASS if code type indicates C/A code (CODE_L1C or CODE_L2C). Uses satellite-specific biases from nav.cbias.</p>
<p>Ionosphere-Free Combination (if opt.ionoopt == IONOOPT_IFLC):
    Uses dual-frequency pseudoranges (P1, P2) to form ionosphere-free linear combination:
    p = (P2 - γ·P1) / (1 - γ)
    where γ = (f1/f2)² (frequency ratio squared).</p>
<pre><code>For BeiDou and Galileo, additional TGD/BDG corrections are applied before combination.
System-specific frequency constants and bias models are used (GPS, GLO, GAL, CMP, IRN).
</code></pre>
<p>Single-Frequency Mode (default):
    Applies only TGD or BGD correction to P1. Sets var[0] = 0.3² (default code variance).
    System-specific TGD models applied (e.g., GPS TGD, GLO –dtaun, GAL BGD, etc.).</p>


<details class="supported-gnss" open>
  <summary>Supported GNSS</summary>
  <p>GPS / QZSS: L1-L2 (IFLC) or L1-only
GLONASS: G1-G2 (IFLC) or G1-only
Galileo: E1-E5b (IFLC) or E1-only (BGD applied)
BeiDou: B1-B2 (IFLC) or B1I/B1Cp/B1Cd (TGD/ISC applied)
NavIC (IRNSS): L5-S (IFLC) or L5-only</p>
</details>

            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prange</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the corrected pseudorange for a single satellite observation, applying differential code bias (DCB) and ionospheric delay corrections based on configuration.</span>
<span class="sd">    Supports both single-frequency and ionosphere-free dual-frequency combinations.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    obs (obsd_t):</span>
<span class="sd">        Single satellite observation record from an epoch (e.g., obs.data[i]). Must contain pseudorange measurements (P[0], P[1]) and signal codes (code[0], code[1]).</span>

<span class="sd">    nav (nav_t):</span>
<span class="sd">        Ephemeris and satellite bias structure containing DCB (differential code bias) and TGD (time group delay) corrections.</span>

<span class="sd">    opt (prcopt_t or equivalent):</span>
<span class="sd">        Processing options structure. Key field:</span>
<span class="sd">        opt.ionoopt: Specifies ionospheric correction mode (e.g., IONOOPT_IFLC for ionosphere-free linear combination).</span>

<span class="sd">    var (Arr1Ddouble, length ≥ 1):</span>
<span class="sd">        Output array — var[0] is set to the default code variance (0.3² m²) for single-frequency cases. Not modified in dual-frequency mode.</span>

<span class="sd">    Returns:</span>
<span class="sd">    p (float):</span>
<span class="sd">        Corrected pseudorange in meters. Returns 0.0 if:</span>
<span class="sd">        P1 is missing, or</span>
<span class="sd">        Dual-frequency mode is enabled but P2 is missing.</span>

<span class="sd">    Processing Logic:</span>
<span class="sd">    DCB Correction (C1→P1, C2→P2):</span>
<span class="sd">        Applied for GPS and GLONASS if code type indicates C/A code (CODE_L1C or CODE_L2C). Uses satellite-specific biases from nav.cbias.</span>

<span class="sd">    Ionosphere-Free Combination (if opt.ionoopt == IONOOPT_IFLC):</span>
<span class="sd">        Uses dual-frequency pseudoranges (P1, P2) to form ionosphere-free linear combination:</span>
<span class="sd">        p = (P2 - γ·P1) / (1 - γ)</span>
<span class="sd">        where γ = (f1/f2)² (frequency ratio squared).</span>

<span class="sd">        For BeiDou and Galileo, additional TGD/BDG corrections are applied before combination.</span>
<span class="sd">        System-specific frequency constants and bias models are used (GPS, GLO, GAL, CMP, IRN).</span>

<span class="sd">    Single-Frequency Mode (default):</span>
<span class="sd">        Applies only TGD or BGD correction to P1. Sets var[0] = 0.3² (default code variance).</span>
<span class="sd">        System-specific TGD models applied (e.g., GPS TGD, GLO –dtaun, GAL BGD, etc.).</span>

<span class="sd">    Supported GNSS:</span>
<span class="sd">        GPS / QZSS: L1-L2 (IFLC) or L1-only</span>
<span class="sd">        GLONASS: G1-G2 (IFLC) or G1-only</span>
<span class="sd">        Galileo: E1-E5b (IFLC) or E1-only (BGD applied)</span>
<span class="sd">        BeiDou: B1-B2 (IFLC) or B1I/B1Cp/B1Cd (TGD/ISC applied)</span>
<span class="sd">        NavIC (IRNSS): L5-S (IFLC) or L5-only</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">sat</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sat</span>

    <span class="n">sys_name</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Dchar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">prl</span><span class="o">.</span><span class="n">satno2id</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span><span class="n">sys_name</span><span class="p">)</span>
    <span class="n">sys</span> <span class="o">=</span> <span class="n">SYS</span><span class="p">[</span><span class="n">sys_name</span><span class="o">.</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">P1</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">ionoopt</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">IONOOPT_IFLC</span> <span class="ow">and</span> <span class="n">P2</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="c1"># P1-C1, P2-C2 DCB correction</span>
    <span class="k">if</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GPS</span> <span class="ow">or</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GLO</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L1C</span><span class="p">:</span>
            <span class="n">P1</span> <span class="o">+=</span> <span class="n">nav</span><span class="o">.</span><span class="n">cbias</span><span class="p">[</span><span class="n">sat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># C1-&gt;P1</span>
        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L2C</span><span class="p">:</span>
            <span class="n">P2</span> <span class="o">+=</span> <span class="n">nav</span><span class="o">.</span><span class="n">cbias</span><span class="p">[</span><span class="n">sat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># C2-&gt;P2</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">ionoopt</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">IONOOPT_IFLC</span><span class="p">:</span>  <span class="c1"># dual-frequency</span>
        <span class="k">if</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GPS</span> <span class="ow">or</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_QZS</span><span class="p">:</span>  <span class="c1"># L1-L2, G1-G2</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ1</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">P2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GLO</span><span class="p">:</span>  <span class="c1"># G1-G2</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ1_GLO</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ2_GLO</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">P2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GAL</span><span class="p">:</span>  <span class="c1"># E1-E5b</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ1</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ7</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">prl</span><span class="o">.</span><span class="n">getseleph</span><span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">SYS_GAL</span><span class="p">):</span>  <span class="c1"># F/NAV</span>
                <span class="n">P2</span> <span class="o">-=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># BGD_E5aE5b</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">P2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_CMP</span><span class="p">:</span>  <span class="c1"># B1-B2</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(((</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ1_CMP</span> <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L2I</span> <span class="k">else</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ1</span><span class="p">)</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ2_CMP</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L2I</span> <span class="k">else</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L1P</span> <span class="k">else</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># TGD_B1I / TGD_B1Cp / TGD_B1Cp+ISC_B1Cd</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># TGD_B2I/B2bI (m)</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">P2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">b2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">b1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_IRN</span><span class="p">:</span>  <span class="c1"># L5-S</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ5</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ9</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">P2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># single-freq (L1/E1/B1)</span>
        <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GPS</span> <span class="ow">or</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_QZS</span><span class="p">:</span>  <span class="c1"># L1</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># TGD (m)</span>
            <span class="k">return</span> <span class="n">P1</span> <span class="o">-</span> <span class="n">b1</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GLO</span><span class="p">:</span>  <span class="c1"># G1</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ1_GLO</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ2_GLO</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># -dtaun (m)</span>
            <span class="k">return</span> <span class="n">P1</span> <span class="o">-</span> <span class="n">b1</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_GAL</span><span class="p">:</span>  <span class="c1"># E1</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">prl</span><span class="o">.</span><span class="n">getseleph</span><span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">SYS_GAL</span><span class="p">)</span> <span class="k">else</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># BGD_E1E5a / BGD_E1E5b</span>
            <span class="k">return</span> <span class="n">P1</span> <span class="o">-</span> <span class="n">b1</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_CMP</span><span class="p">:</span>  <span class="c1"># B1I/B1Cp/B1Cd</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L2I</span> <span class="k">else</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">CODE_L1P</span> <span class="k">else</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># TGD_B1I / TGD_B1Cp / TGD_B1Cp+ISC_B1Cd</span>
            <span class="k">return</span> <span class="n">P1</span> <span class="o">-</span> <span class="n">b1</span>
        <span class="k">elif</span> <span class="n">sys</span> <span class="o">==</span> <span class="n">prl</span><span class="o">.</span><span class="n">SYS_IRN</span><span class="p">:</span>  <span class="c1"># L5</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">prl</span><span class="o">.</span><span class="n">FREQ9</span> <span class="o">/</span> <span class="n">prl</span><span class="o">.</span><span class="n">FREQ5</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">gettgd</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># TGD (m)</span>
            <span class="k">return</span> <span class="n">P1</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">b1</span>
    <span class="k">return</span> <span class="n">P1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.preprocess_obs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preprocess_obs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Preprocesses GNSS observation data for positioning.</p>
<p>Parameters:
o (obs_t): GNSS observation data structure for one epoch.
nav (nav_t): Navigation data structure with ephemerides and satellite biases.
use_cache (bool, optional): Whether to use cached results if available.</p>
<p>Returns:
dict: A dictionary containing preprocessing results and status information.</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_obs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocesses GNSS observation data for positioning.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    o (obs_t): GNSS observation data structure for one epoch.</span>
<span class="sd">    nav (nav_t): Navigation data structure with ephemerides and satellite biases.</span>
<span class="sd">    use_cache (bool, optional): Whether to use cached results if available.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary containing preprocessing results and status information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">o_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># intialize with pntpos can help fix some position-related parameters, such as sagnac, ionosphere, troposphere, or it need a iteration to solve it.</span>
    <span class="n">sol</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">get_obs_pnt</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">nav</span><span class="p">)</span>
    <span class="c1"># if not status:</span>
    <span class="c1">#     return [[None] * 7][0]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sol</span><span class="o">.</span><span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sol</span><span class="o">.</span><span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sol</span><span class="o">.</span><span class="n">rr</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
    <span class="n">satpos</span><span class="p">,</span><span class="n">sdt</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">mask</span> <span class="o">=</span> <span class="n">get_sat_pos</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="n">nav</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">prcopt_default</span>
    <span class="n">vmeas</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">arr_select</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">n</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sagnac</span> <span class="o">=</span> <span class="n">get_sagnac_corr</span><span class="p">(</span><span class="n">satpos</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">iono_error</span><span class="p">,</span> <span class="n">trop_error</span><span class="p">,</span> <span class="n">var_els</span><span class="p">,</span> <span class="n">var_ions</span><span class="p">,</span> <span class="n">var_tropos</span> <span class="o">=</span> <span class="n">get_atmosphere_error</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">satpos</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sat</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">)],</span> <span class="n">nav</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">satpos_enu</span> <span class="o">=</span> <span class="n">ecef_to_enu_direct</span><span class="p">(</span><span class="n">satpos</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">],</span><span class="n">p</span><span class="p">)</span>
    <span class="n">az</span><span class="p">,</span><span class="n">el</span> <span class="o">=</span> <span class="n">enu_to_azel</span><span class="p">(</span><span class="n">satpos_enu</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
        <span class="n">obsd</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># store raw data</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">SNR</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">1000</span>
        <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;LLI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">LLI</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">sname</span> <span class="o">=</span> <span class="n">get_sat_name</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">sat</span><span class="p">)</span>
        <span class="n">s_sys</span> <span class="o">=</span> <span class="n">sname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">corrected_p</span> <span class="o">=</span> <span class="n">prange</span><span class="p">(</span><span class="n">obsd</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">vmeas</span><span class="p">)</span>
        <span class="n">dop</span> <span class="o">=</span> <span class="n">obsd</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">corrected_p</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">freq</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">sat2freq</span><span class="p">(</span><span class="n">obsd</span><span class="o">.</span><span class="n">sat</span><span class="p">,</span><span class="n">obsd</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nav</span><span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">obsd</span><span class="o">.</span><span class="n">sat</span><span class="p">,</span>
                <span class="n">sname</span><span class="p">,</span>
                <span class="n">s_sys</span><span class="p">,</span>
                <span class="n">satpos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">sdt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">corrected_p</span><span class="p">,</span>
                <span class="n">sagnac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">iono_error</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">trop_error</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">obsd</span><span class="o">.</span><span class="n">SNR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">vmeas</span><span class="o">.</span><span class="n">ptr</span><span class="o">+</span><span class="n">var_els</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">var_ions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">var_tropos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">az</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">el</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="o">-</span><span class="n">prl</span><span class="o">.</span><span class="n">CLIGHT</span><span class="o">/</span><span class="n">freq</span><span class="o">*</span><span class="n">dop</span><span class="p">,</span>
                <span class="n">freq</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;satpos&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s1">&#39;pr&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;dop&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;sdt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s1">&#39;sagnac&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s1">&#39;sys&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p_t</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ret_data</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">cdata</span><span class="p">,</span><span class="n">raw_data</span><span class="p">]</span>
    <span class="c1"># if it&#39;s initialization, do not store the position and receiver clock bias</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret_data</span>
    <span class="k">return</span> <span class="n">ret_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.pseudorange_observe_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pseudorange_observe_func</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">satpos</span><span class="p">,</span> <span class="n">sdt</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sagnac</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">keep_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Computes pseudorange observation residuals and their Jacobian matrix for GNSS positioning.
Models geometric range, Sagnac effect, receiver-satellite clock bias difference, and optional iono/tropo delays.
The state vector assumed is: [x, y, z, dt_sys1, dt_sys2, ...] — position + per-system clock bias (no velocity or clock drift).
Clock drift is handled externally (e.g., in Doppler module), enabling modular design via block_diag fusion.</p>
<p>Parameters:
pos : receiver position (ECEF), shape (3,)
dt : receiver clock bias per GNSS system, shape (n_sys,), unit: m
    → e.g., dt = [dt_GPS, dt_GAL, dt_BDS, ...]
satpos : satellite positions (ECEF), shape (n_obs, 3)
sdt : satellite clock biases (from broadcast/SP3), shape (n_obs,), unit: s
I : ionospheric delay (optional, can be zero), shape (n_obs, 1), unit: m
T : tropospheric delay (optional, can be zero), shape (n_obs, 1), unit: m
sagnac : precomputed Sagnac correction term (from get_sagnac_corr), shape (n_obs, 1), unit: m
sys : list of GNSS system identifiers for each observation, e.g., ['G', 'E', 'C']
keep_states : if False, removes Jacobian columns corresponding to systems with no observation (for WLS compatibility)
enable_torch : if True, use PyTorch backend for computations
device : if enable_torch is True, specifies the device ('cpu' or 'cuda')</p>
<p>Returns:
psr : predicted pseudorange residuals (m), shape (n_obs, 1)
H : Jacobian matrix w.r.t state [x, y, z, dt_sys1, dt_sys2, ...], shape (n_obs, 3 + n_active_sys)</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pseudorange_observe_func</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">satpos</span><span class="p">,</span> <span class="n">sdt</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sagnac</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">keep_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes pseudorange observation residuals and their Jacobian matrix for GNSS positioning.</span>
<span class="sd">    Models geometric range, Sagnac effect, receiver-satellite clock bias difference, and optional iono/tropo delays.</span>
<span class="sd">    The state vector assumed is: [x, y, z, dt_sys1, dt_sys2, ...] — position + per-system clock bias (no velocity or clock drift).</span>
<span class="sd">    Clock drift is handled externally (e.g., in Doppler module), enabling modular design via block_diag fusion.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    pos : receiver position (ECEF), shape (3,)</span>
<span class="sd">    dt : receiver clock bias per GNSS system, shape (n_sys,), unit: m</span>
<span class="sd">        → e.g., dt = [dt_GPS, dt_GAL, dt_BDS, ...]</span>
<span class="sd">    satpos : satellite positions (ECEF), shape (n_obs, 3)</span>
<span class="sd">    sdt : satellite clock biases (from broadcast/SP3), shape (n_obs,), unit: s</span>
<span class="sd">    I : ionospheric delay (optional, can be zero), shape (n_obs, 1), unit: m</span>
<span class="sd">    T : tropospheric delay (optional, can be zero), shape (n_obs, 1), unit: m</span>
<span class="sd">    sagnac : precomputed Sagnac correction term (from get_sagnac_corr), shape (n_obs, 1), unit: m</span>
<span class="sd">    sys : list of GNSS system identifiers for each observation, e.g., [&#39;G&#39;, &#39;E&#39;, &#39;C&#39;]</span>
<span class="sd">    keep_states : if False, removes Jacobian columns corresponding to systems with no observation (for WLS compatibility)</span>
<span class="sd">    enable_torch : if True, use PyTorch backend for computations</span>
<span class="sd">    device : if enable_torch is True, specifies the device (&#39;cpu&#39; or &#39;cuda&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">    psr : predicted pseudorange residuals (m), shape (n_obs, 1)</span>
<span class="sd">    H : Jacobian matrix w.r.t state [x, y, z, dt_sys1, dt_sys2, ...], shape (n_obs, 3 + n_active_sys)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">Backend</span><span class="p">(</span><span class="n">enable_torch</span><span class="p">)</span>

    <span class="n">satpos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">sdt</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sdt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">sagnac</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sagnac</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">satpos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">satpos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">sdt</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">sdt</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">sagnac</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">sagnac</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1">#dt = dt/prl.CLIGHT # convert m to s</span>

    <span class="c1"># 几何距离 + 单位向量</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">satpos</span> <span class="o">-</span> <span class="n">pos</span>  <span class="c1"># shape: (n_obs, 3)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_norm</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs, 1)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span> <span class="o">/</span> <span class="n">norm</span>  <span class="c1"># shape: (n_obs, 3)</span>

    <span class="n">psr1</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">+</span> <span class="n">sagnac</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs, 1)</span>
    <span class="n">psr2</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">prl</span><span class="o">.</span><span class="n">CLIGHT</span> <span class="o">*</span> <span class="n">sdt</span>       <span class="c1"># shape: (n_obs,)</span>
    <span class="n">psr3</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">T</span>                         <span class="c1"># shape: (n_obs, 1)</span>

    <span class="n">psr</span> <span class="o">=</span> <span class="n">psr1</span> <span class="o">+</span> <span class="n">psr2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">psr3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_obs, 1)</span>

    <span class="c1"># 构造钟差映射矩阵 H_t: (n_obs, n_sys)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">eye_matrix</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">H_t</span> <span class="o">=</span> <span class="n">eye_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># shape: (n_obs, n_sys)</span>

    <span class="c1"># 可选：移除无观测系统的列</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_states</span><span class="p">:</span>
        <span class="n">non_zero_cols</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">H_t</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: (n_sys,)</span>
        <span class="n">H_t</span> <span class="o">=</span> <span class="n">H_t</span><span class="p">[:,</span> <span class="n">non_zero_cols</span><span class="p">]</span>  <span class="c1"># shape: (n_obs, n_active_sys)</span>

    <span class="n">H_t</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">H_t</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># 构造完整 Jacobian: [∂psr/∂x, ∂psr/∂y, ∂psr/∂z, ∂psr/∂dt1, ∂psr/∂dt2, ...]</span>
    <span class="n">H_pos</span> <span class="o">=</span> <span class="n">e</span>  <span class="c1"># shape: (n_obs, 3)</span>
    <span class="n">H_clock</span> <span class="o">=</span> <span class="n">H_t</span>  <span class="c1"># shape: (n_obs, n_sys) or (n_obs, n_active_sys)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H_pos</span><span class="p">,</span> <span class="n">H_clock</span><span class="p">))</span>  <span class="c1"># shape: (n_obs, 3 + n_sys)</span>

    <span class="k">return</span> <span class="n">psr</span><span class="p">,</span> <span class="n">H</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.read_obs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_obs</span><span class="p">(</span><span class="n">rcv</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reads GNSS observation and ephemeris data from RINEX files using RTKLIB’s internal structures.</p>
        <p>rcv (str or list of str):
    Path(s) to RINEX observation file(s) containing receiver measurements.
    These files are read as observation data (type 1 in RTKLIB).</p>
<p>eph (str or list of str):
    Path(s) to RINEX navigation/ephemeris file(s).
    These files are read as ephemeris data (type 2 in RTKLIB).</p>
<p>ref (str or list of str, optional):
    Path(s) to RINEX observation file(s) from a reference station, used for Real-Time Kinematic (RTK) processing.
    If provided, these are also read as type 2 (ephemeris-type) data for reference station handling.</p>
<p>Returns:
obs_t: RTKLIB structure containing GNSS observation data (pseudorange, carrier phase, etc.).
nav_t: RTKLIB structure containing satellite ephemeris, clock, and ionospheric model data.
sta_t: RTKLIB structure containing station information (e.g., antenna position, receiver info), primarily populated when reading reference station files.</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_obs</span><span class="p">(</span><span class="n">rcv</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads GNSS observation and ephemeris data from RINEX files using RTKLIB’s internal structures.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    rcv (str or list of str):</span>
<span class="sd">        Path(s) to RINEX observation file(s) containing receiver measurements.</span>
<span class="sd">        These files are read as observation data (type 1 in RTKLIB).</span>

<span class="sd">    eph (str or list of str):</span>
<span class="sd">        Path(s) to RINEX navigation/ephemeris file(s).</span>
<span class="sd">        These files are read as ephemeris data (type 2 in RTKLIB).</span>

<span class="sd">    ref (str or list of str, optional):</span>
<span class="sd">        Path(s) to RINEX observation file(s) from a reference station, used for Real-Time Kinematic (RTK) processing.</span>
<span class="sd">        If provided, these are also read as type 2 (ephemeris-type) data for reference station handling.</span>

<span class="sd">    Returns:</span>
<span class="sd">    obs_t: RTKLIB structure containing GNSS observation data (pseudorange, carrier phase, etc.).</span>
<span class="sd">    nav_t: RTKLIB structure containing satellite ephemeris, clock, and ionospheric model data.</span>
<span class="sd">    sta_t: RTKLIB structure containing station information (e.g., antenna position, receiver info), primarily populated when reading reference station files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">obs_t</span><span class="p">()</span>
    <span class="n">nav</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">nav_t</span><span class="p">()</span>
    <span class="n">sta</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">sta_t</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rcv</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rcv</span><span class="p">:</span>
            <span class="n">prl</span><span class="o">.</span><span class="n">readrnx</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">readrnx</span><span class="p">(</span><span class="n">rcv</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">eph</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">eph</span><span class="p">:</span>
            <span class="n">prl</span><span class="o">.</span><span class="n">readrnx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">readrnx</span><span class="p">(</span><span class="n">eph</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ref</span><span class="p">:</span>
                <span class="n">prl</span><span class="o">.</span><span class="n">readrnx</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prl</span><span class="o">.</span><span class="n">readrnx</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obs</span><span class="p">,</span><span class="n">nav</span><span class="p">,</span><span class="n">sta</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.split_obs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ref_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Splits a monolithic obs_t structure into a list of obs_t objects, each containing observations from a single epoch.
This facilitates per-epoch processing in applications such as RTK or time-series analysis.</p>
        <p>obs (obs_t):
    The input observation structure, typically generated by read_obs(). All observations across all epochs are stored in obs.data.</p>
<p>ref_obs (bool, optional, default=True):
    If True, includes reference station observations (receiver ID = 2) in the split epoch data.
    If False, only observations from the primary receiver (receiver ID = 1) are retained per epoch.</p>
        <p>List[obs_t]:
    A list of obs_t structures, each representing one epoch’s worth of observation data. Each element contains:
    .data: Array of observations for that epoch.
    .n: Actual number of observations in the epoch.
    .nmax: Maximum allocated size (equal to total observations detected for the epoch).</p>
<p>Behavior:
First calls pyrtklib.sortobs(obs) to ensure observations are sorted chronologically by time and receiver.
Iterates through epochs using nextobsf(obs, i) to locate epoch boundaries.
For each epoch:
    Allocates a new obs_t structure.
    Copies observations from receiver 1 (primary).
    If ref_obs=True, also copies observations from receiver 2 (reference station), appending them after receiver 1’s data.
    Skips epochs with no primary receiver data.
Returns the list of per-epoch obs_t structures.</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ref_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits a monolithic obs_t structure into a list of obs_t objects, each containing observations from a single epoch.</span>
<span class="sd">    This facilitates per-epoch processing in applications such as RTK or time-series analysis.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    obs (obs_t):</span>
<span class="sd">        The input observation structure, typically generated by read_obs(). All observations across all epochs are stored in obs.data.</span>

<span class="sd">    ref_obs (bool, optional, default=True):</span>
<span class="sd">        If True, includes reference station observations (receiver ID = 2) in the split epoch data.</span>
<span class="sd">        If False, only observations from the primary receiver (receiver ID = 1) are retained per epoch.</span>

<span class="sd">    Returns:</span>
<span class="sd">    List[obs_t]:</span>
<span class="sd">        A list of obs_t structures, each representing one epoch’s worth of observation data. Each element contains:</span>
<span class="sd">        .data: Array of observations for that epoch.</span>
<span class="sd">        .n: Actual number of observations in the epoch.</span>
<span class="sd">        .nmax: Maximum allocated size (equal to total observations detected for the epoch).</span>

<span class="sd">    Behavior:</span>
<span class="sd">    First calls pyrtklib.sortobs(obs) to ensure observations are sorted chronologically by time and receiver.</span>
<span class="sd">    Iterates through epochs using nextobsf(obs, i) to locate epoch boundaries.</span>
<span class="sd">    For each epoch:</span>
<span class="sd">        Allocates a new obs_t structure.</span>
<span class="sd">        Copies observations from receiver 1 (primary).</span>
<span class="sd">        If ref_obs=True, also copies observations from receiver 2 (reference station), appending them after receiver 1’s data.</span>
<span class="sd">        Skips epochs with no primary receiver data.</span>
<span class="sd">    Returns the list of per-epoch obs_t structures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prl</span><span class="o">.</span><span class="n">sortobs</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">nextobsf</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">obss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">m</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">tmp_obs</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">obs_t</span><span class="p">()</span>
        <span class="n">tmp_obs</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Dobsd_t</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">rcv1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rcv2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">rcv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tmp_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">rcv1</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
                <span class="n">rcv1</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">rcv1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span><span class="o">+=</span><span class="n">m</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">nextobsf</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">rcv1</span> <span class="o">!=</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">ref_obs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="n">rcv1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">rcv1</span><span class="p">]</span><span class="o">.</span><span class="n">rcv</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">tmp_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">rcv1</span><span class="o">+</span><span class="n">rcv2</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">rcv1</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">rcv2</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">tmp_obs</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">rcv1</span><span class="o">+</span><span class="n">rcv2</span>
        <span class="n">tmp_obs</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">i</span><span class="o">+=</span><span class="n">m</span>
        <span class="n">obss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_obs</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">nextobsf</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obss</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.wls_pnt_pos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wls_pnt_pos</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_residual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Performs Weighted Least Squares (WLS) positioning using GNSS observations.</p>
<p>This function implements an iterative WLS algorithm to solve for receiver position, velocity,
and clock parameters. It supports caching for performance optimization and PyTorch backend
for gradient-based optimization.</p>
<p>Key Features:
- Uses caching to accelerate repeated calls with the same observation data
- Supports PyTorch backend for gradient propagation, enabling use in neural network optimization
- Handles multiple GNSS constellations with separate clock bias parameters
- Includes atmospheric and relativistic corrections</p>
        <p>o (obs_t): 
    GNSS observation data structure for one epoch.
nav (nav_t): 
    Navigation data structure with ephemerides and satellite biases.
use_cache (bool, optional): 
    Whether to use cached preprocessing results. When True, if the same
    observation object is processed multiple times, the preprocessing results (satellite positions,
    atmospheric corrections, etc.) are cached and reused, significantly speeding up repeated calls.
    Default is True.
return_residual (bool, optional): 
    Whether to return residuals, Jacobian matrix, and weight matrix.
    When True, the returned dictionary includes a "residual_info" key containing:
    - "residual": Observation residuals vector
    - "H": Design matrix (Jacobian)
    - "W": Weight matrix
    These can be used to compute Dilution of Precision (DOP) metrics. Default is False.
enable_torch (bool, optional): 
    Whether to use PyTorch backend for computations. When True,
    the function uses PyTorch tensors and operations, allowing gradients to flow through the
    computation graph. This enables the use of this function in neural network training, where
    weights (w) and bias (b) can be optimized using gradient descent. Default is False.
w (array-like, optional): Weight matrix for pseudorange observations. If enable_torch=True,
    gradients will propagate through w to the position solution, allowing wp to be optimized
    in neural networks. Default is None (uses inverse of observation variance).
b (array-like, optional): Bias vector to be subtracted from pseudorange observations. If
    enable_torch=True, gradients will propagate through b to the position solution, allowing
    b to be optimized in neural networks. Default is None (zero vector).
device (str, optional): Device to run PyTorch computations on ('cpu' or 'cuda'). Default is 'cpu'.</p>
        <p>dict: A dictionary containing positioning results, status, and additional information with keys:
    - "status" (bool): True if positioning succeeded, False otherwise
    - "pos" (array): Receiver position [x, y, z] in ECEF coordinates
    - "cb" (array): Receiver clock bias for each GNSS system
    - "cd" (array): Receiver clock drift
    - "msg" (str): Status message
    - "data" (array): Processed observation data
    - "solve_data" (dict): Preprocessed data used in solving
    - "raw_data" (dict): Raw observation data
    - "residual_info" (dict, optional): Residuals and Jacobian matrix if return_residual=True</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">wls_pnt_pos</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_residual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs Weighted Least Squares (WLS) positioning using GNSS observations.</span>

<span class="sd">    This function implements an iterative WLS algorithm to solve for receiver position, velocity,</span>
<span class="sd">    and clock parameters. It supports caching for performance optimization and PyTorch backend</span>
<span class="sd">    for gradient-based optimization.</span>

<span class="sd">    Key Features:</span>
<span class="sd">    - Uses caching to accelerate repeated calls with the same observation data</span>
<span class="sd">    - Supports PyTorch backend for gradient propagation, enabling use in neural network optimization</span>
<span class="sd">    - Handles multiple GNSS constellations with separate clock bias parameters</span>
<span class="sd">    - Includes atmospheric and relativistic corrections</span>

<span class="sd">    Parameters:</span>
<span class="sd">    o (obs_t): </span>
<span class="sd">        GNSS observation data structure for one epoch.</span>
<span class="sd">    nav (nav_t): </span>
<span class="sd">        Navigation data structure with ephemerides and satellite biases.</span>
<span class="sd">    use_cache (bool, optional): </span>
<span class="sd">        Whether to use cached preprocessing results. When True, if the same</span>
<span class="sd">        observation object is processed multiple times, the preprocessing results (satellite positions,</span>
<span class="sd">        atmospheric corrections, etc.) are cached and reused, significantly speeding up repeated calls.</span>
<span class="sd">        Default is True.</span>
<span class="sd">    return_residual (bool, optional): </span>
<span class="sd">        Whether to return residuals, Jacobian matrix, and weight matrix.</span>
<span class="sd">        When True, the returned dictionary includes a &quot;residual_info&quot; key containing:</span>
<span class="sd">        - &quot;residual&quot;: Observation residuals vector</span>
<span class="sd">        - &quot;H&quot;: Design matrix (Jacobian)</span>
<span class="sd">        - &quot;W&quot;: Weight matrix</span>
<span class="sd">        These can be used to compute Dilution of Precision (DOP) metrics. Default is False.</span>
<span class="sd">    enable_torch (bool, optional): </span>
<span class="sd">        Whether to use PyTorch backend for computations. When True,</span>
<span class="sd">        the function uses PyTorch tensors and operations, allowing gradients to flow through the</span>
<span class="sd">        computation graph. This enables the use of this function in neural network training, where</span>
<span class="sd">        weights (w) and bias (b) can be optimized using gradient descent. Default is False.</span>
<span class="sd">    w (array-like, optional): Weight matrix for pseudorange observations. If enable_torch=True,</span>
<span class="sd">        gradients will propagate through w to the position solution, allowing wp to be optimized</span>
<span class="sd">        in neural networks. Default is None (uses inverse of observation variance).</span>
<span class="sd">    b (array-like, optional): Bias vector to be subtracted from pseudorange observations. If</span>
<span class="sd">        enable_torch=True, gradients will propagate through b to the position solution, allowing</span>
<span class="sd">        b to be optimized in neural networks. Default is None (zero vector).</span>
<span class="sd">    device (str, optional): Device to run PyTorch computations on (&#39;cpu&#39; or &#39;cuda&#39;). Default is &#39;cpu&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary containing positioning results, status, and additional information with keys:</span>
<span class="sd">        - &quot;status&quot; (bool): True if positioning succeeded, False otherwise</span>
<span class="sd">        - &quot;pos&quot; (array): Receiver position [x, y, z] in ECEF coordinates</span>
<span class="sd">        - &quot;cb&quot; (array): Receiver clock bias for each GNSS system</span>
<span class="sd">        - &quot;cd&quot; (array): Receiver clock drift</span>
<span class="sd">        - &quot;msg&quot; (str): Status message</span>
<span class="sd">        - &quot;data&quot; (array): Processed observation data</span>
<span class="sd">        - &quot;solve_data&quot; (dict): Preprocessed data used in solving</span>
<span class="sd">        - &quot;raw_data&quot; (dict): Raw observation data</span>
<span class="sd">        - &quot;residual_info&quot; (dict, optional): Residuals and Jacobian matrix if return_residual=True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">o_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">o_id</span> <span class="ow">in</span> <span class="n">cache_data</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">p_t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cdata</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">p_t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cdata</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="n">preprocess_obs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">)</span>

    <span class="c1"># test cdata[&#39;sys&#39;], check the number of systems and the number of unknowns</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;insufficient satellites for the number of systems&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span>
        <span class="p">}</span>


    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">backend</span> <span class="o">=</span> <span class="n">Backend</span><span class="p">(</span><span class="n">enable_torch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># initalize variables</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ensure_array</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p_t</span> <span class="o">=</span> <span class="n">ensure_array</span><span class="p">(</span><span class="n">p_t</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">),))</span>


    <span class="c1"># ensure all variables are on the correct device</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">p_t</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">p_t</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="n">dp</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">100.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># construct p_t_mask</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># 索引用 int64</span>
    <span class="n">eye_matrix</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">p_t_mask</span> <span class="o">=</span> <span class="n">eye_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> 
    <span class="n">p_t_mask</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">p_t_mask</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># process b</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># process Wpr</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">W_pr</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">W_pr</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">w_tensor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">W_pr</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">backend</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>


    <span class="n">W</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">W_pr</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># ensure cdata pr and dop are tensors on the correct device</span>
    <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pr_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="n">maxiter</span> <span class="ow">and</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_norm</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">psr</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">pseudorange_observe_func</span><span class="p">(</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_t_mask</span><span class="p">,</span> <span class="n">p_t</span><span class="p">),</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;sdt&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sagnac&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">],</span> <span class="n">enable_torch</span><span class="o">=</span><span class="n">enable_torch</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span>
            <span class="p">)</span>


            <span class="n">p_residual</span> <span class="o">=</span> <span class="n">pr_tensor</span> <span class="o">-</span> <span class="n">psr</span> <span class="o">-</span> <span class="n">b</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">p_residual</span>


            <span class="c1"># solve least squares</span>
            <span class="n">W_H</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
            <span class="n">W_r</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_lstsq</span><span class="p">(</span><span class="n">W_H</span><span class="p">,</span> <span class="n">W_r</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">solution</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;solution&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># update</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dp</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">p_t</span> <span class="o">=</span> <span class="n">p_t</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">zero_pos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">zero_pos</span><span class="p">,</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="n">maxiter</span> <span class="ow">or</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_norm</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">zero_pos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">zero_pos</span><span class="p">,</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;not converge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span>
        <span class="p">}</span>

    <span class="c1"># store to cache</span>
    <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">p_t</span><span class="p">)</span>


    <span class="c1"># optional: return residuals and H</span>
    <span class="k">if</span> <span class="n">return_residual</span><span class="p">:</span>
        <span class="n">psr</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">pseudorange_observe_func</span><span class="p">(</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_t_mask</span><span class="p">,</span> <span class="n">p_t</span><span class="p">),</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;sdt&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sagnac&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">],</span> <span class="n">enable_torch</span><span class="o">=</span><span class="n">enable_torch</span>
        <span class="p">)</span>

        <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pr_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="n">residual</span> <span class="o">=</span> <span class="n">pr_tensor</span> <span class="o">-</span> <span class="n">psr</span> <span class="o">-</span> <span class="n">b</span>
        <span class="n">residual_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;residual&quot;</span><span class="p">:</span> <span class="n">residual</span><span class="p">,</span>
            <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span>
            <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="n">W</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">residual_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="s2">&quot;cb&quot;</span><span class="p">:</span> <span class="n">p_t</span><span class="p">,</span>
        <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
        <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
        <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span><span class="p">,</span>
        <span class="s2">&quot;residual_info&quot;</span><span class="p">:</span> <span class="n">residual_info</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.wls_pnt_pos_vel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wls_pnt_pos_vel</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_residual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Performs Weighted Least Squares (WLS) positioning using GNSS observations.</p>
<p>This function implements an iterative WLS algorithm to solve for receiver position, velocity,
and clock parameters. It supports caching for performance optimization and PyTorch backend
for gradient-based optimization.</p>
<p>Key Features:
- Uses caching to accelerate repeated calls with the same observation data
- Supports PyTorch backend for gradient propagation, enabling use in neural network optimization
- Handles multiple GNSS constellations with separate clock bias parameters
- Includes atmospheric and relativistic corrections</p>
        <p>o (obs_t): 
    GNSS observation data structure for one epoch.
nav (nav_t): 
    Navigation data structure with ephemerides and satellite biases.
use_cache (bool, optional): 
    Whether to use cached preprocessing results. When True, if the same
    observation object is processed multiple times, the preprocessing results (satellite positions,
    atmospheric corrections, etc.) are cached and reused, significantly speeding up repeated calls.
    Default is True.
return_residual (bool, optional): 
    Whether to return residuals, Jacobian matrix, and weight matrix.
    When True, the returned dictionary includes a "residual_info" key containing:
    - "residual": Observation residuals vector
    - "H": Design matrix (Jacobian)
    - "W": Weight matrix
    These can be used to compute Dilution of Precision (DOP) metrics. Default is False.
enable_torch (bool, optional): 
    Whether to use PyTorch backend for computations. When True,
    the function uses PyTorch tensors and operations, allowing gradients to flow through the
    computation graph. This enables the use of this function in neural network training, where
    weights (wp, wv) and bias (b) can be optimized using gradient descent. Default is False.
wp (array-like, optional): Weight matrix for pseudorange observations. If enable_torch=True,
    gradients will propagate through wp to the position solution, allowing wp to be optimized
    in neural networks. Default is None (uses inverse of observation variance).
wv (array-like, optional): Weight matrix for Doppler observations. If enable_torch=True,
    gradients will propagate through wv to the position solution. Default is None (uses wp*10).
b (array-like, optional): Bias vector to be subtracted from pseudorange observations. If
    enable_torch=True, gradients will propagate through b to the position solution, allowing
    b to be optimized in neural networks. Default is None (zero vector).
device (str, optional): Device to run PyTorch computations on ('cpu' or 'cuda'). Default is 'cpu'.</p>
        <p>dict: A dictionary containing positioning results, status, and additional information with keys:
    - "status" (bool): True if positioning succeeded, False otherwise
    - "pos" (array): Receiver position [x, y, z] in ECEF coordinates
    - "velocity" (array): Receiver velocity [vx, vy, vz] in ECEF coordinates
    - "cb" (array): Receiver clock bias for each GNSS system
    - "cd" (array): Receiver clock drift
    - "msg" (str): Status message
    - "data" (array): Processed observation data
    - "solve_data" (dict): Preprocessed data used in solving
    - "raw_data" (dict): Raw observation data
    - "residual_info" (dict, optional): Residuals and Jacobian matrix if return_residual=True</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">wls_pnt_pos_vel</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_residual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_torch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs Weighted Least Squares (WLS) positioning using GNSS observations.</span>

<span class="sd">    This function implements an iterative WLS algorithm to solve for receiver position, velocity,</span>
<span class="sd">    and clock parameters. It supports caching for performance optimization and PyTorch backend</span>
<span class="sd">    for gradient-based optimization.</span>

<span class="sd">    Key Features:</span>
<span class="sd">    - Uses caching to accelerate repeated calls with the same observation data</span>
<span class="sd">    - Supports PyTorch backend for gradient propagation, enabling use in neural network optimization</span>
<span class="sd">    - Handles multiple GNSS constellations with separate clock bias parameters</span>
<span class="sd">    - Includes atmospheric and relativistic corrections</span>

<span class="sd">    Parameters:</span>
<span class="sd">    o (obs_t): </span>
<span class="sd">        GNSS observation data structure for one epoch.</span>
<span class="sd">    nav (nav_t): </span>
<span class="sd">        Navigation data structure with ephemerides and satellite biases.</span>
<span class="sd">    use_cache (bool, optional): </span>
<span class="sd">        Whether to use cached preprocessing results. When True, if the same</span>
<span class="sd">        observation object is processed multiple times, the preprocessing results (satellite positions,</span>
<span class="sd">        atmospheric corrections, etc.) are cached and reused, significantly speeding up repeated calls.</span>
<span class="sd">        Default is True.</span>
<span class="sd">    return_residual (bool, optional): </span>
<span class="sd">        Whether to return residuals, Jacobian matrix, and weight matrix.</span>
<span class="sd">        When True, the returned dictionary includes a &quot;residual_info&quot; key containing:</span>
<span class="sd">        - &quot;residual&quot;: Observation residuals vector</span>
<span class="sd">        - &quot;H&quot;: Design matrix (Jacobian)</span>
<span class="sd">        - &quot;W&quot;: Weight matrix</span>
<span class="sd">        These can be used to compute Dilution of Precision (DOP) metrics. Default is False.</span>
<span class="sd">    enable_torch (bool, optional): </span>
<span class="sd">        Whether to use PyTorch backend for computations. When True,</span>
<span class="sd">        the function uses PyTorch tensors and operations, allowing gradients to flow through the</span>
<span class="sd">        computation graph. This enables the use of this function in neural network training, where</span>
<span class="sd">        weights (wp, wv) and bias (b) can be optimized using gradient descent. Default is False.</span>
<span class="sd">    wp (array-like, optional): Weight matrix for pseudorange observations. If enable_torch=True,</span>
<span class="sd">        gradients will propagate through wp to the position solution, allowing wp to be optimized</span>
<span class="sd">        in neural networks. Default is None (uses inverse of observation variance).</span>
<span class="sd">    wv (array-like, optional): Weight matrix for Doppler observations. If enable_torch=True,</span>
<span class="sd">        gradients will propagate through wv to the position solution. Default is None (uses wp*10).</span>
<span class="sd">    b (array-like, optional): Bias vector to be subtracted from pseudorange observations. If</span>
<span class="sd">        enable_torch=True, gradients will propagate through b to the position solution, allowing</span>
<span class="sd">        b to be optimized in neural networks. Default is None (zero vector).</span>
<span class="sd">    device (str, optional): Device to run PyTorch computations on (&#39;cpu&#39; or &#39;cuda&#39;). Default is &#39;cpu&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary containing positioning results, status, and additional information with keys:</span>
<span class="sd">        - &quot;status&quot; (bool): True if positioning succeeded, False otherwise</span>
<span class="sd">        - &quot;pos&quot; (array): Receiver position [x, y, z] in ECEF coordinates</span>
<span class="sd">        - &quot;velocity&quot; (array): Receiver velocity [vx, vy, vz] in ECEF coordinates</span>
<span class="sd">        - &quot;cb&quot; (array): Receiver clock bias for each GNSS system</span>
<span class="sd">        - &quot;cd&quot; (array): Receiver clock drift</span>
<span class="sd">        - &quot;msg&quot; (str): Status message</span>
<span class="sd">        - &quot;data&quot; (array): Processed observation data</span>
<span class="sd">        - &quot;solve_data&quot; (dict): Preprocessed data used in solving</span>
<span class="sd">        - &quot;raw_data&quot; (dict): Raw observation data</span>
<span class="sd">        - &quot;residual_info&quot; (dict, optional): Residuals and Jacobian matrix if return_residual=True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">o_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">o_id</span> <span class="ow">in</span> <span class="n">cache_data</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">p_t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cdata</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">p_t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cdata</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="n">preprocess_obs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">)</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">backend</span> <span class="o">=</span> <span class="n">Backend</span><span class="p">(</span><span class="n">enable_torch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># initalize variables</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ensure_array</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p_t</span> <span class="o">=</span> <span class="n">ensure_array</span><span class="p">(</span><span class="n">p_t</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">),))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">ensure_array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">v_t</span> <span class="o">=</span> <span class="n">ensure_array</span><span class="p">(</span><span class="n">v_t</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

    <span class="c1"># ensure all variables are on the correct device</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">p_t</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">p_t</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">v_t</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">v_t</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="n">dp</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">100.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># construct p_t_mask</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># 索引用 int64</span>
    <span class="n">eye_matrix</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SYS_NAME</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">p_t_mask</span> <span class="o">=</span> <span class="n">eye_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> 
    <span class="n">p_t_mask</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">p_t_mask</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># process b</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># process Wpr</span>
    <span class="k">if</span> <span class="n">wp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">wp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">W_pr</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wp_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">W_pr</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">wp_tensor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">W_pr</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">backend</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

    <span class="c1"># process Wdop</span>
    <span class="k">if</span> <span class="n">wv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wv_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">W_dop</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">wv_tensor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">W_dop</span> <span class="o">=</span> <span class="n">W_pr</span> <span class="o">*</span> <span class="mf">100.0</span> 

    <span class="c1"># combine W</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="n">W_pr</span><span class="p">,</span> <span class="n">W_dop</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="c1"># ensure cdata pr and dop are tensors on the correct device</span>
    <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dop_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;dop&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pr_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">dop_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dop_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="n">maxiter</span> <span class="ow">and</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_norm</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">psr</span><span class="p">,</span> <span class="n">H_psr</span> <span class="o">=</span> <span class="n">pseudorange_observe_func</span><span class="p">(</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_t_mask</span><span class="p">,</span> <span class="n">p_t</span><span class="p">),</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;sdt&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sagnac&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">],</span> <span class="n">enable_torch</span><span class="o">=</span><span class="n">enable_torch</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span>
            <span class="p">)</span>
            <span class="n">dop</span><span class="p">,</span> <span class="n">H_dop</span> <span class="o">=</span> <span class="n">doppler_observe_func</span><span class="p">(</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,</span><span class="mi">3</span><span class="p">:],</span>
                <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;sdt&quot;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">],</span> <span class="n">enable_torch</span><span class="o">=</span><span class="n">enable_torch</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span>
            <span class="p">)</span>


            <span class="n">p_residual</span> <span class="o">=</span> <span class="n">pr_tensor</span> <span class="o">-</span> <span class="n">psr</span> <span class="o">-</span> <span class="n">b</span>
            <span class="n">d_residual</span> <span class="o">=</span> <span class="n">dop_tensor</span> <span class="o">-</span> <span class="n">dop</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">p_residual</span><span class="p">,</span> <span class="n">d_residual</span><span class="p">))</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="n">H_psr</span><span class="p">,</span> <span class="n">H_dop</span><span class="p">)</span>


            <span class="c1"># solve least squares</span>
            <span class="n">W_H</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
            <span class="n">W_r</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_lstsq</span><span class="p">(</span><span class="n">W_H</span><span class="p">,</span> <span class="n">W_r</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">solution</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;solution&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># update</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dp</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">p_t</span> <span class="o">=</span> <span class="n">p_t</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">v_t</span> <span class="o">=</span> <span class="n">v_t</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">zero_pos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">zero_pos</span><span class="p">,</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="n">maxiter</span> <span class="ow">or</span> <span class="n">backend</span><span class="o">.</span><span class="n">linalg_norm</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">zero_pos</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">zero_pos</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">zero_pos</span><span class="p">,</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;not converge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span>
        <span class="p">}</span>

    <span class="c1"># store to cache</span>
    <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">p_t</span><span class="p">)</span>
    <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">cache_data</span><span class="p">[</span><span class="n">o_id</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">v_t</span><span class="p">)</span>

    <span class="c1"># optional: return residuals and H</span>
    <span class="k">if</span> <span class="n">return_residual</span><span class="p">:</span>
        <span class="n">psr</span><span class="p">,</span> <span class="n">Hp</span> <span class="o">=</span> <span class="n">pseudorange_observe_func</span><span class="p">(</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_t_mask</span><span class="p">,</span> <span class="n">p_t</span><span class="p">),</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;sdt&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sagnac&#39;</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">],</span> <span class="n">enable_torch</span><span class="o">=</span><span class="n">enable_torch</span>
        <span class="p">)</span>
        <span class="n">dop</span><span class="p">,</span> <span class="n">Hd</span> <span class="o">=</span> <span class="n">doppler_observe_func</span><span class="p">(</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,:</span><span class="mi">3</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;satpos&#39;</span><span class="p">][:,</span><span class="mi">3</span><span class="p">:],</span>
            <span class="n">cdata</span><span class="p">[</span><span class="s2">&quot;sdt&quot;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">],</span> <span class="n">enable_torch</span><span class="o">=</span><span class="n">enable_torch</span>
        <span class="p">)</span>

        <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;pr&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">dop_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cdata</span><span class="p">[</span><span class="s1">&#39;dop&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">pr_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pr_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">dop_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dop_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="n">residual_p</span> <span class="o">=</span> <span class="n">pr_tensor</span> <span class="o">-</span> <span class="n">psr</span> <span class="o">-</span> <span class="n">b</span>
        <span class="n">residual_d</span> <span class="o">=</span> <span class="n">dop_tensor</span> <span class="o">-</span> <span class="n">dop</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">residual_p</span><span class="p">,</span> <span class="n">residual_d</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="n">Hp</span><span class="p">,</span> <span class="n">Hd</span><span class="p">)</span>
        <span class="n">residual_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;residual&quot;</span><span class="p">:</span> <span class="n">residual</span><span class="p">,</span>
            <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span>
            <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="n">W</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">residual_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span>
        <span class="s2">&quot;cb&quot;</span><span class="p">:</span> <span class="n">p_t</span><span class="p">,</span>
        <span class="s1">&#39;cd&#39;</span><span class="p">:</span> <span class="n">v_t</span><span class="p">,</span>
        <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
        <span class="s2">&quot;solve_data&quot;</span><span class="p">:</span> <span class="n">cdata</span><span class="p">,</span>
        <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">raw_data</span><span class="p">,</span>
        <span class="s2">&quot;residual_info&quot;</span><span class="p">:</span> <span class="n">residual_info</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="tasgnss.xyz2enu" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">xyz2enu</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert ECEF coordinates to ENU rotation matrix
Parameters:
    pos: tuple or array of (lat, lon) in degrees or radians
    deg: if True, pos is in degrees, else in radians
Returns:
    E: 3x3 rotation matrix from ECEF to ENU</p>


            <details class="quote">
              <summary>Source code in <code>tasgnss/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xyz2enu</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ECEF coordinates to ENU rotation matrix</span>
<span class="sd">    Parameters:</span>
<span class="sd">        pos: tuple or array of (lat, lon) in degrees or radians</span>
<span class="sd">        deg: if True, pos is in degrees, else in radians</span>
<span class="sd">    Returns:</span>
<span class="sd">        E: 3x3 rotation matrix from ECEF to ENU</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">_pos</span> <span class="o">=</span> <span class="n">prl</span><span class="o">.</span><span class="n">Arr1Ddouble</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">prl</span><span class="o">.</span><span class="n">D2R</span>
        <span class="n">_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">prl</span><span class="o">.</span><span class="n">D2R</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">xyz2enu</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prl</span><span class="o">.</span><span class="n">xyz2enu</span><span class="p">(</span><span class="n">_pos</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": "math", "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>